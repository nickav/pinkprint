#!/usr/bin/env node

const path = require('path');
const yargs = require('yargs');

const packageJson = require('../package.json');
const main = require('../src');

const root = main.findProjectRoot() || process.cwd();
const config = (main.loadConfig(root) || {}).default;
const me = path.basename(__filename);

const ctx = { me, root, config };

const invalidCommand = (argv) => {
  const cmd = argv._[0];
  if (!cmd) {
    console.log(`Please specify a command. See '${me} --help'`);
    return;
  }

  console.log(`'${cmd}' is not a valid ${me} command. See '${me} --help'`);
};

const cli = yargs
  .command(
    ['new <name>', 'n'],
    'Creates a new pinkprint',
    () => {},
    (argv) => main.runNew(ctx, argv)
  )

  .command(
    ['list', 'l'],
    'List all commands',
    () => {},
    (argv) => main.runList(ctx, argv)
  )

  .command(
    ['generate <template> <name> [args..]', 'g'],
    'Creates files from a pinkprint template',
    (yargs) => {
      yargs.option('preview', {
        describe: 'Preview without modifying any files',
        alias: 'p',
        default: false,
      });
    },
    (argv) => main.runGenerate(ctx, argv)
  )

  .option('verbose', {
    describe: 'Print verbose output',
    default: false,
  })

  .help('help')
  .alias('help', 'h')
  .example('pink new reducer', 'Create a new pinkprint')
  .example('pink list', 'Show all pinkprint commands')
  .example('pink generate component Button', 'Generate files')

  .version('version', packageJson.version)
  .alias('version', 'v');

const commands = config.commands || [];
Object.keys(commands).forEach((key) => {
  const command = commands[key];

  cli.command(
    [key],
    command.description || '',
    (yargs) => {
      (command.args || []).forEach((arg) =>
        yargs.option(arg, typeof arg === 'string' ? { describe: ' ' } : arg)
      );
    },
    (argv) => main.generate(ctx, argv, key, command)
  );
});

cli
  .usage(`Usage: ${me} <command> [options]`)
  .command('*', '', () => {}, invalidCommand).argv;
